# tests/test_liveness.py
from crawler.liveness import classify_domains


def test_classify_domains_live_dead(monkeypatch):
    # Fake DNS resolution
    monkeypatch.setattr("crawler.liveness.resolve_host", lambda host: True)

    class R:
        def __init__(self, code): self.status_code = code

    def fake_head(url, **kw):
        if "live.example" in url: return R(200)
        if "four.example" in url: return R(404)  # 4xx -> live by default
        return R(503)  # dead

    monkeypatch.setattr("requests.head", fake_head)

    urls = [
        "https://live.example.nz/start",
        "https://dead.example.nz/x",
        "https://four.example.nz/y",
    ]
    res = classify_domains(urls, timeout=2, treat_4xx_as_live=True, max_workers=2)
    assert res["example.nz"] == "live"   # live.example.nz
    assert res["four.example.nz"] == "live"
    assert res["dead.example.nz"] == "dead"
