<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Phishing Web Crawler Jobs</title>

  <!-- Bootstrap CSS + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    /* Color-coded text for statuses */
    .status-running  { color: #198754; font-weight: 600; } /* green */
    .status-paused   { color: #6c757d; font-weight: 600; } /* gray  */
    .status-finished { color: #0d6efd; font-weight: 600; } /* blue  */
    .status-failed   { color: #dc3545; font-weight: 600; } /* red   */

    /* Ensure borders are visible even if other CSS overrides exist */
    .table-bordered > :not(caption) > * > * {
      border-width: 1px !important;
      border-color: rgba(0,0,0,.2) !important;
    }

    /* Optional: sticky header for wide tables */
    /* Note: 'position: sticky' may not work in all browsers (e.g., older IE/Edge).
       For best results, ensure the parent container (e.g., .table-responsive) has 'overflow: auto' or 'overflow-x: auto'. */
    thead th { position: sticky; top: 0; z-index: 2; }

    body { font-family: sans-serif; margin: 2em; }
    .filters { margin-bottom: 2em; padding: 1em; background: #f5f5f5; }
    .pagination { margin: 1em 0; }
    .pagination a { padding: 0.5em; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 0.5em; border: 1px solid #ddd; }
    th { background: #f5f5f5; }
    .current-page { font-weight: bold; }
  </style>
</head>
<body class="bg-light">
<div class="container-fluid py-4">
  <h1 class="mb-3">Phishing Web Crawler Job Status</h1>
  {# 'now' is a template variable containing the current timestamp (string), injected by the backend for display #}
  <p class="text-muted">Last updated: {{ now }}</p>

  <!-- Filters -->
  <form class="row g-2 align-items-end filters" method="get" action="{{ url_for('index') }}">
    <div class="col-auto">
      <label class="form-label">Status</label>
      <select name="status" class="form-select form-select-sm">
        <option value="">All</option>
        <option value="PENDING" {% if filters.status == 'PENDING' %}selected{% endif %}>PENDING</option>
        <option value="RUNNING" {% if filters.status == 'RUNNING' %}selected{% endif %}>RUNNING</option>
        <option value="SUCCEEDED" {% if filters.status == 'SUCCEEDED' %}selected{% endif %}>SUCCEEDED</option>
        <option value="FAILED" {% if filters.status == 'FAILED' %}selected{% endif %}>FAILED</option>
      </select>
    </div>

    <div class="col-auto">
      <label class="form-label">Jurisdiction</label>
      <select name="jurisdiction" class="form-select form-select-sm">
        <option value="">All</option>
        {% for j in jurisdictions %}
          <option value="{{ j }}" {% if filters.jurisdiction == j %}selected{% endif %}>{{ j }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-auto">
      <label class="form-label">Validation Date From</label>
      <input type="date" name="date_from" value="{{ filters.date_from or '' }}" class="form-control form-control-sm">
    </div>

    <div class="col-auto">
      <label class="form-label">Validation Date To</label>
      <input type="date" name="date_to" value="{{ filters.date_to or '' }}" class="form-control form-control-sm">
    </div>

    <div class="col-auto">
      <button class="btn btn-primary btn-sm" type="submit"><i class="bi bi-funnel-fill"></i> Apply</button>
      <a class="btn btn-secondary btn-sm" href="{{ url_for('index') }}">Reset</a>
    </div>
  </form>

  <div class="table-responsive">
    <table class="table table-sm table-striped table-hover table-bordered align-middle">
      <thead class="table-dark">
        <tr>
          <th>URL</th>
          <th>Job Type</th>
          <th>Job Status</th>
          <th>Jurisdiction</th>
          <th>NCA</th>
          <th>Validation Date</th>
          <th>Crawl Count</th>
          <th>Files</th>
          <th>Created At</th>
          <th>Last Update</th>
        </tr>
      </thead>
      <tbody>
        {% set status_map = {
          'RUNNING':'status-running',
          'SUCCEEDED':'status-finished',
          'FAILED':'status-failed',
          'PENDING':'status-paused',
          'UNKNOWN':'text-muted'
        } %}

        {% for row in rows %}
        <tr>
          <td><code>{{ row.url }}</code></td>
          <td>
            {% if row.type == 'LIVE_CRAWL' %}
              <span class="badge bg-success">
                <i class="bi bi-check-circle-fill"></i> Live Crawling
              </span>
            {% elif row.type == 'WAYBACK_DOWNLOAD' %}
              <span class="badge bg-secondary">
                <i class="bi bi-dash-circle-fill"></i> Wayback Download
              </span>
            {% else %}
              <span class="badge bg-light text-dark">
                <i class="bi bi-question-circle-fill"></i> {{ row.type or 'unknown' }}
              </span>
            {% endif %}
          </td>
          <td>
            {% if row.status %}
              <span class="{{ status_map.get(row.status|upper, 'text-muted') }}">
                {{ row.status }}
              </span>
            {% endif %}
          </td>
          <td>{{ row.jurisdiction or '' }}</td>
          <td>{{ row.nca_name or '' }}</td>
          <td>{{ row.validation_date or '' }}</td>
          <td>{{ row.crawl_count or 0 }}</td>
          <td>{{ row.last_crawl_file_count or 0 }}</td>
          <td>{{ row.created_at or '' }}</td>
          <td>{{ row.last_update or '' }}</td>
        </tr>
        {% else %}
        <tr>
          <td colspan="10" class="text-center text-muted">No jobs found</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <nav aria-label="Jobs pagination" class="mt-3">
    {% if pages and pages > 1 %}
    <ul class="pagination pagination-sm">
      {% for p in range(1, pages + 1) %}
        {% set args = request.args.to_dict() %}
        {% do args.update({'page': p}) %}
        <li class="page-item {% if p == current_page %}active{% endif %}">
          <a class="page-link" href="{{ url_for('index', **args) }}">{{ p }}</a>
        </li>
      {% endfor %}
    </ul>
    {% endif %}
  </nav>

</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<!-- Bootstrap JS (enables tooltips) -->
<script>
  // Enable tooltips
  if (window.bootstrap && bootstrap.Tooltip) {
    document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(function (el) {
      new bootstrap.Tooltip(el);
    });
  }
</script>
</body>
</html>
